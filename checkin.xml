<agendas>
  <agenda> <!--Check-in: rules to validate Item; barcode check; checks based on item status (in transit; intransit for hold; intransit for staff request) and setting new status; checks for requests against the item and setting new statuses; Contains sub rules for check in policies based on combined characteristics of item and patron; Policies set "lost" and overdue penalties-->
    <name>Check-in Validation</name>
    <rules>
      <rule> <!--InTransitCheck; if containsFunction(itemlocation, operatorsCirculationLocation), then (if itemstatus in (intransit), then itemstatus = AVAILABLE, else (if shelvingLagTime > 0, then updateItemStatus=Recently-Returned, Else updateItemStatus = Available)), else updateItemStatus = INTRANSIT-->
        <name>InTransitCheck</name>
        <oleProposition> <!--if containsFunction(itemlocation, operatorsCirculationLocation)-->
          <type>simple</type>
          <simpleProposition>
            <function>containsFunction</function>
            <term>
              <type>java.lang.String</type>
              <value>itemLocation</value>
            </term>
            <term>
              <type>java.lang.String</type>
              <value>operatorsCirculationLocation</value>
            </term>
          </simpleProposition>
        </oleProposition>
        <trueActions> <!--then (run rule Recently returned Check based on inTransit: if shelvingLagTime > 0, then updateItemStatus=Recently-Returned, Else  updateItemStatus = Available)-->
          <rule> <!--Recently returned Check based on inTransit: if shelvingLagTime > 0, then updateItemStatus=Recently-Returned, Else updateItemStatus = Available-->
            <name>Recently returned Check based on inTransit</name>
            <oleProposition> <!--if shelvingLagTime > 0-->
              <type>simple</type>
              <simpleProposition>
                <term>
                  <type>java.lang.Integer</type>
                  <value>shelvingLagTime</value>
                </term>
                <operator>greaterThan</operator>
                <values>
                  <value>
                    <type>java.lang.Integer</type>
                    <name>0</name>
                  </value>
                </values>
              </simpleProposition>
            </oleProposition>
            <trueActions> <!--then updateItemStatus=Recently-Returned-->
              <action>
                <name>updateItemStatus</name>
                <parameter>
                  <name>updateItemStatus</name>
                  <value>RECENTLY-RETURNED</value>
                </parameter>
              </action>
            </trueActions>
            <falseActions> <!--else updateItemStatus = Available-->
              <action>
                <name>updateItemStatus</name>
                <parameter>
                  <name>updateItemStatus</name>
                  <value>AVAILABLE</value>
                </parameter>
              </action>
            </falseActions>
          </rule>
        </trueActions>
        <falseActions> <!--else updateItemStatus = INTRANSIT-->
          <action>
            <name>updateItemStatus</name>
            <parameter>
              <name>updateItemStatus</name>
              <value>INTRANSIT</value>
            </parameter>
          </action>
        </falseActions>
      </rule>
      
      
      <rule> <!--OnHoldInPickupLocation: if containsFunction(itemPickupLocation, operatorsCirculationLocation) AND itemStatus in (INTRANSIT-FOR-HOLD) then updateItemStatus to ONHOLD-->
        <name>OnHoldInPickupLocation</name>
        <oleProposition> <!--if containsFunction(itemPickupLocation, operatorsCirculationLocation) AND itemStatus in (INTRANSIT-FOR-HOLD)-->
          <type>compound</type>
          <compoundProposition>
            <operator>AND</operator>
            <simpleProposition> <!--if containsFunction(itemPickupLocation, operatorsCirculationLocation)-->
              <function>containsFunction</function>
              <term>
                <type>java.lang.String</type>
                <value>itemPickUpLocation</value>
              </term>
              <term>
                <type>java.lang.String</type>
                <value>operatorsCirculationLocation</value>
              </term>
            </simpleProposition>
            <simpleProposition> <!--if itemStatus in (INTRANSIT-FOR-HOLD)-->
              <term>
                <type>java.lang.String</type>
                <value>itemStatus</value>
              </term>
              <operator>IN</operator>
              <values>
                <value>
                  <type>java.lang.String</type>
                  <name>INTRANSIT-FOR-HOLD</name>
                </value>
              </values>
            </simpleProposition>
          </compoundProposition>
        </oleProposition>
        <trueActions> <!--then updateItemStatus to ONHOLD-->
          <action>
            <name>updateItemStatus</name>
            <parameter>
              <name>updateItemStatus</name>
              <value>ONHOLD</value>
            </parameter>
          </action>
        </trueActions>
      </rule>

      
      <rule> <!--(StaffRequest)NotCheckedOut: if containsFunction(destinationLocation), [a circulation desk selected by the staff person and does not need to be a 'pickup location' circdesk] operatorsCirculationLocation) AND itemStatus in (Intransit-Per-Staff-Request), then run rule 'Recently returned Check based on Staff'-->
        <name>NotCheckedOut</name>
        <oleProposition> <!--if containsFunction(destinationLocation, operatorsCirculationLocation) AND itemStatus in (Intransit-Per-Staff-Request)-->
          <type>compound</type>
          <compoundProposition>
            <operator>AND</operator>
            <simpleProposition> <!--if containsFunction(destinationLocation, operatorsCirculationLocation)-->
              <function>containsFunction</function>
              <term>
                <type>java.lang.String</type>
                <value>destinationLocation</value>
              </term>
              <term>
                <type>java.lang.String</type>
                <value>operatorsCirculationLocation</value>
              </term>
            </simpleProposition>
            <simpleProposition> <!--if itemStatus in (Intransit-Per-Staff-Request)-->
              <term>
                <type>java.lang.String</type>
                <value>itemStatus</value>
              </term>
              <operator>IN</operator>
              <values>
                <value>
                  <type>java.lang.String</type>
                  <name>INTRANSIT-PER-STAFF-REQUEST</name>
                </value>
              </values>
            </simpleProposition>
          </compoundProposition>
        </oleProposition>
        <trueActions>
          <rule> <!--Recently returned Check based on staff: if shelvingLagTime > 0, then updateItemStatus = Recently-Returned, else updateItemStatus = Available-->
            <name>Recently returned Check based on staff</name>
            <oleProposition> <!--if shelvingLagTime > 0-->
              <type>simple</type>
              <simpleProposition>
                <term>
                  <type>java.lang.Integer</type>
                  <value>shelvingLagTime</value>
                </term>
                <operator>greaterThan</operator>
                <values>
                  <value>
                    <type>java.lang.Integer</type>
                    <name>0</name>
                  </value>
                </values>
              </simpleProposition>
            </oleProposition>
            <trueActions> <!--then updateItemStatus = Recently-Returned-->
              <action>
                <name>updateItemStatus</name>
                <parameter>
                  <name>updateItemStatus</name>
                  <value>RECENTLY-RETURNED</value>
                </parameter>
              </action>
            </trueActions>
            <falseActions> <!--else updateItemStatus = Available-->
              <action>
                <name>updateItemStatus</name>
                <parameter>
                  <name>updateItemStatus</name>
                  <value>AVAILABLE</value>
                </parameter>
              </action>
            </falseActions>
          </rule>
        </trueActions>
      </rule>
            

      <rule> <!--DeliveryRequest: if requestType in (Recall/Delivery Request, Hold/Delivery Request),then checkout = content for mail-->
        <name>DeliveryRequest</name>
        <oleProposition> <!--if requestType in (Recall/Delivery Request, Hold/Delivery Request)-->
          <type>simple</type>
          <simpleProposition>
            <term>
              <type>java.lang.String</type>
              <value>requestType</value>
            </term>
            <operator>IN</operator>
            <values>
              <value>
                <type>java.lang.String</type>
                <name>Recall/Delivery Request</name>
              </value>
              <value>
                <type>java.lang.String</type>
                <name>Hold/Delivery Request</name>
              </value>
            </values>
          </simpleProposition>
        </oleProposition>
        <trueActions> <!--then checkout = content for mail-->
          <action>
            <name>checkout</name>
            <parameter>
              <name>checkout</name>
              <value>Content for mail</value>
            </parameter>
          </action>
        </trueActions>
      </rule>
      
      
      <rule> <!--Request Exists Check: if requestType in (Recall/Delivery Request, Hold/Delivery Request,Recall/Hold Request,Hold/Hold Request,Page/Hold Request),then display error-->
        <name>Request Exists Check</name>
        <oleProposition> <!--if requestType in (Recall/Delivery Request, Hold/Delivery Request,Recall/Hold Request,Hold/Hold Request,Page/Hold Request)-->
          <type>simple</type>
          <simpleProposition>
            <term>
              <type>java.lang.String</type>
              <value>requestType</value>
            </term>
            <operator>IN</operator>
            <values>
              <value>
                <type>java.lang.String</type>
                <name>Recall/Delivery Request</name>
              </value>
              <value>
                <type>java.lang.String</type>
                <name>Hold/Delivery Request</name>
              </value>
              <value>
                <type>java.lang.String</type>
                <name>Recall/Hold Request</name>
              </value>
              <value>
                <type>java.lang.String</type>
                <name>Hold/Hold Request</name>
              </value>
              <value>
                <type>java.lang.String</type>
                <name>Page/Hold Request</name>
              </value>
            </values>
          </simpleProposition>
        </oleProposition>
        <trueActions> <!--then display error-->
          <action>
            <name>errorAction</name>
            <parameter>
              <name>errorMessage</name>
              <value>Request Exists for this Item</value>
            </parameter>
          </action>
        </trueActions>
      </rule>
      
      
      <rule> <!--HoldRequest: if requestType in (Recall/Hold Request, Hold/Hold Request, Page/Hold Request), then run rule LocationCheck-->
        <name>HoldRequest</name>
        <oleProposition> <!--if requestType in (Recall/Hold Request, Hold/Hold Request, Page/Hold Request)-->
          <type>simple</type>
          <simpleProposition>
            <term>
              <type>java.lang.String</type>
              <value>requestType</value>
            </term>
            <operator>IN</operator>
            <values>
              <value>
                <type>java.lang.String</type>
                <name>Recall/Hold Request</name>
              </value>
              <value>
                <type>java.lang.String</type>
                <name>Hold/Hold Request</name>
              </value>
              <value>
                <type>java.lang.String</type>
                <name>Page/Hold Request</name>
              </value>
              <value>
                <type>java.lang.String</type>
                <name>ASR Request</name>
              </value>
            </values>
          </simpleProposition>
        </oleProposition>
        <trueActions> <!--run rule LocationCheck-->
          <rule> <!--if containsFunction(itemPickUpLocation, operatorsCirculationLocation), then updateItemStatus = onhold, else updateItemStatus = Intransit-For-Hold-->
            <name>LocationCheck</name>
            <oleProposition> <!--if containsFunction(itemPickUpLocation, operatorsCirculationLocation)-->
              <type>simple</type>
              <simpleProposition>
                <function>containsFunction</function>
                <term>
                  <type>java.lang.String</type>
                  <value>itemPickUpLocation</value>
                </term>
                <term>
                  <type>java.lang.String</type>
                  <value>operatorsCirculationLocation</value>
                </term>
              </simpleProposition>
            </oleProposition>
            <trueActions> <!--then updateItemStatus = onhold-->
              <action>
                <name>updateItemStatus</name>
                <parameter>
                  <name>updateItemStatus</name>
                  <value>ONHOLD</value>
                </parameter>
              </action>
            </trueActions>
            <falseActions> <!--else updateItemStatus = Intransit-For-Hold-->
              <action>
                <name>updateItemStatus</name>
                <parameter>
                  <name>updateItemStatus</name>
                  <value>INTRANSIT-FOR-HOLD</value>
                </parameter>
              </action>
            </falseActions>
          </rule>
        </trueActions>
      </rule>
            

      <!--[FACULTY OR STAFF], Item Type: [01, 03] -->
      <rule>
        <name>CHECKIN_FAC_STAFF_01_03</name>
        <oleProposition> <!--check borrowerType, itemType, and itemLibrary-->
          <type>compound</type>
          <compoundProposition>
            <operator>AND</operator>
            <simpleProposition> <!--if borrower in (FAC, STAFF)-->
              <term>
                <type>java.lang.String</type>
                <value>borrowerType</value>
              </term>
              <operator>IN</operator>
              <values>
                <value>
                  <type>java.lang.String</type>
                  <name>FAC</name>
                </value>
                <value>
                  <type>java.lang.String</type>
                  <name>STAFF</name>
                </value>
              </values>
            </simpleProposition>
            <simpleProposition> <!--If item in (01, 03)-->
              <term>
                <type>java.lang.String</type>
                <value>itemType</value>
              </term>
              <operator>IN</operator>
              <values>
                <value>
                  <type>java.lang.String</type>
                  <name>01</name>
                </value>
                <value>
                  <type>java.lang.String</type>
                  <name>03</name>
                </value>
              </values>
            </simpleProposition>
          </compoundProposition>
        </oleProposition>
        <trueActions>
          <action> <!--then circulationPolicyFound = true-->
            <name>circulationPolicyFound</name>
            <parameter>
              <name>circulationPolicyFound</name>
              <value>true</value>
            </parameter>
          </action>
          <!-- No fines, so do nothing -->
        </trueActions>
      </rule>
      
      
      <!--[UGRAD OR GRAD], Item Type: [01, 03] -->
      <rule>
        <name>CHECKIN_UGRAD_GRAD_01_03</name>
        <oleProposition> <!--check borrowerType, itemType, and itemLibrary-->
          <type>compound</type>
          <compoundProposition>
            <operator>AND</operator>
            <simpleProposition> <!--if borrower in (UGRAD, GRAD)-->
              <term>
                <type>java.lang.String</type>
                <value>borrowerType</value>
              </term>
              <operator>IN</operator>
              <values>
                <value>
                  <type>java.lang.String</type>
                  <name>UGRAD</name>
                </value>
                <value>
                  <type>java.lang.String</type>
                  <name>STAFF</name>
                </value>
              </values>
            </simpleProposition>
            <simpleProposition> <!--If item in (01, 03)-->
              <term>
                <type>java.lang.String</type>
                <value>itemType</value>
              </term>
              <operator>IN</operator>
              <values>
                <value>
                  <type>java.lang.String</type>
                  <name>01</name>
                </value>
                <value>
                  <type>java.lang.String</type>
                  <name>03</name>
                </value>
              </values>
            </simpleProposition>
          </compoundProposition>
        </oleProposition>
        <trueActions>
          <action> <!--then circulationPolicyFound = true-->
            <name>circulationPolicyFound</name>
            <parameter>
              <name>circulationPolicyFound</name>
              <value>true</value>
            </parameter>
          </action>
          <rule>
            <name>OverdueFineCalculation</name>
            <oleProposition> <!--if today (I think) =itemDueDate-->
              <type>compound</type>
              <compoundProposition>
                <operator>AND</operator>
                <simpleProposition>
                  <function>currentDateFunction</function>
                  <term>
                    <type>java.util.Date</type>
                    <value>itemDueDate</value>
                  </term>
                </simpleProposition>
                <simpleProposition>
                  <term>
                    <type>java.lang.boolean</type>
                    <value>claimsReturnedFlag</value>
                  </term>
                  <operator>=</operator>
                  <values>
                    <value>
                      <type>java.lang.boolean</type>
                      <name>false</name>
                    </value>
                  </values>
                </simpleProposition>
              </compoundProposition>
            </oleProposition>
            <trueActions>
              <action> <!--overduefine=50 cents/D-->
                <name>overdueFine</name>
                <parameter>
                  <name>overdueFine</name>
                  <value>0.50/D</value>
                </parameter>
              </action>
              <action> <!--MaxFine=100 dollars-->
                <name>maxFine</name>
                <parameter>
                  <name>maxFine</name>
                  <value>100</value>
                </parameter>
              </action>
            </trueActions>
          </rule>
        </trueActions>
      </rule>
      
      <!--Item Type: [65] -->
      <rule>
        <name>CHECKIN_ALL_65</name>
        <oleProposition> <!--check borrowerType, itemType, and itemLibrary-->
          <type>simple</type>
          <simpleProposition> <!--If item in (65)-->
            <term>
              <type>java.lang.String</type>
              <value>itemType</value>
            </term>
            <operator>IN</operator>
            <values>
              <value>
                <type>java.lang.String</type>
                <name>65</name>
              </value>
            </values>
          </simpleProposition>
        </oleProposition>
        <trueActions>
          <action> <!--then circulationPolicyFound = true-->
            <name>circulationPolicyFound</name>
            <parameter>
              <name>circulationPolicyFound</name>
              <value>true</value>
            </parameter>
          </action>
          <rule>
            <name>OverdueFineCalculation</name>
            <oleProposition> <!--if today (I think) =itemDueDate-->
              <type>compound</type>
              <compoundProposition>
                <operator>AND</operator>
                <simpleProposition>
                  <function>currentDateFunction</function>
                  <term>
                    <type>java.util.Date</type>
                    <value>itemDueDate</value>
                  </term>
                </simpleProposition>
                <simpleProposition>
                  <term>
                    <type>java.lang.boolean</type>
                    <value>claimsReturnedFlag</value>
                  </term>
                  <operator>=</operator>
                  <values>
                    <value>
                      <type>java.lang.boolean</type>
                      <name>false</name>
                    </value>
                  </values>
                </simpleProposition>
              </compoundProposition>
            </oleProposition>
            <trueActions>
              <action> <!--overduefine=$1/H-->
                <name>overdueFine</name>
                <parameter>
                  <name>overdueFine</name>
                  <value>1.00/H</value>
                </parameter>
              </action>
              <action> <!--MaxFine=100 dollars-->
                <name>maxFine</name>
                <parameter>
                  <name>maxFine</name>
                  <value>100</value>
                </parameter>
              </action>
            </trueActions>
          </rule>
        </trueActions>
      </rule>


    
      <!--Checkin Policy not found; if isCircPolicyNotFound, then send a message-->
      <rule>
        <name>Check in Circulation Policy Not Found</name>
        <oleProposition>
          <type>simple</type>
          <simpleProposition>
            <function>circulationPolicyFoundFunction</function>
            <term>
              <type>java.lang.String</type>
              <value>patronId</value>
            </term>
            <term>
              <type>java.lang.String</type>
              <value>itemId</value>
            </term>
          </simpleProposition>
        </oleProposition>
        <trueActions>
          <action>
            <name>errorAction</name>
            <parameter>
              <name>errorMessage</name>
              <value>There is no circulation rule for this combination.</value>
            </parameter>
          </action>
        </trueActions>
      </rule>
    </rules>
  </agenda>
</agendas>